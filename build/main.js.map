{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\n * Created with @iobroker/create-adapter v1.32.0\n */\n\nimport * as utils from '@iobroker/adapter-core';\nimport axios from 'axios';\n\ninterface GotifyMessage {\n    message?: string;\n    title?: string;\n    priority?: number;\n    contentType?: string;\n}\n\nclass Gotify extends utils.Adapter {\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'gotify',\n        });\n        this.on('ready', this.onReady.bind(this));\n        this.on('message', this.onMessage.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n    }\n\n    private async migrateConfigurationIfNeeded(): Promise<void> {\n        this.log.debug(`config url: ${this.config.url}`);\n        this.log.debug(`config tokens: ${JSON.stringify(this.config.tokens)}`);\n\n        await this.migrateOldTokenFormat();\n    }\n\n    private async migrateOldTokenFormat(): Promise<void> {\n        if (this.config.token && this.config.tokens && this.config.tokens.length === 0) {\n            this.log.info('Old adapter configuration detected, performing migration...');\n            const alias = 'default';\n            // Token entschl\u00FCsseln falls verschl\u00FCsselt, damit es in this.config entschl\u00FCsselt vorliegt\n            let tokenValue = this.config.token;\n            if (tokenValue.startsWith('$/aes')) {\n                tokenValue = this.decrypt(tokenValue);\n            }\n            this.config.tokens = [{ alias, token: tokenValue, isDefault: true }];\n            this.config.token = '';\n            await this.saveConfigChanges(['tokens'], true);\n            this.log.info('Adapter configuration migrated to multi-token structure.');\n        }\n    }\n\n    private decryptTokensIfNeeded(): void {\n        if (!this.config.tokens || !Array.isArray(this.config.tokens)) {\n            return;\n        }\n\n        for (const t of this.config.tokens) {\n            // Tokens in this.config m\u00FCssen immer entschl\u00FCsselt sein\n            if (t.token && t.token.startsWith('$/aes')) {\n                t.token = this.decrypt(t.token);\n            }\n        }\n    }\n\n    private async saveConfigChanges(fields: string[], deleteOldToken = false): Promise<void> {\n        const obj = await this.getForeignObjectAsync(`system.adapter.${this.name}.${this.instance}`);\n        if (!obj || !obj.native) {\n            return;\n        }\n\n        let changed = false;\n        for (const field of fields) {\n            const currentValue = (this.config as any)[field];\n            const savedValue = obj.native[field];\n\n            if (JSON.stringify(currentValue) !== JSON.stringify(savedValue)) {\n                obj.native[field] = currentValue;\n                changed = true;\n            }\n        }\n\n        if (deleteOldToken && 'token' in obj.native) {\n            delete obj.native.token;\n            changed = true;\n        }\n\n        if (changed) {\n            this.extendForeignObject(`system.adapter.${this.name}.${this.instance}`, obj);\n        }\n    }\n\n    private async updateConnectionState(): Promise<void> {\n        if (this.config.url && this.config.tokens && this.config.tokens.length > 0) {\n            await this.setState('info.connection', true, true);\n            this.log.info('Gotify adapter konfiguriert');\n        } else {\n            await this.setState('info.connection', false, true);\n            this.log.warn('Gotify adapter nicht konfiguriert');\n        }\n    }\n\n    /**\n     * Is called when databases are connected and adapter received configuration.\n     */\n    private async onReady(): Promise<void> {\n        this.log.info('Gotify adapter starting');\n        await this.migrateConfigurationIfNeeded();\n        await this.updateConnectionState();\n        this.log.info('Gotify adapter started');\n    }\n\n    /**\n     * Encrypts all tokens in the array if they are still unencrypted and saves them persistently.\n     */\n    private async encryptTokensIfNeeded(): Promise<void> {\n        const obj = await this.getForeignObjectAsync(`system.adapter.${this.name}.${this.instance}`);\n        let changed = false;\n        if (obj && obj.native && Array.isArray(obj.native.tokens)) {\n            for (const t of obj.native.tokens) {\n                if (t.token && !t.token.startsWith('$/aes')) {\n                    t.token = this.encrypt(t.token);\n                    changed = true;\n                }\n            }\n            if (changed) {\n                this.extendForeignObject(`system.adapter.${this.name}.${this.instance}`, obj);\n                this.log.info('All tokens are now stored encrypted');\n            }\n        }\n    }\n\n    /**\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\n     *\n     * @param callback Callback to be called after shutdown\n     */\n    private onUnload(callback: () => void): void {\n        this.log.info('Gotify adapter shutting down...');\n        try {\n            callback();\n        } catch (e) {\n            this.log.error(`Error during unload: ${JSON.stringify(e)}`);\n            callback();\n        }\n    }\n\n    private onMessage(obj: ioBroker.Message): void {\n        this.log.info(`Received message: ${JSON.stringify(obj)}`);\n        if (typeof obj === 'object' && obj.message) {\n            if (obj.command === 'send') {\n                this.sendMessage(obj.message as GotifyMessage);\n                // Send response in callback if required\n                if (obj.callback) {\n                    this.sendTo(obj.from, obj.command, 'Message received', obj.callback);\n                }\n            } else if (obj.command === 'sendNotification') {\n                this.processNotification(obj);\n            }\n        }\n    }\n\n    private processNotification(obj: ioBroker.Message): void {\n        const notificationMessage: GotifyMessage = this.formatNotification(obj.message);\n        try {\n            this.sendMessage(notificationMessage);\n            if (obj.callback) {\n                this.sendTo(obj.from, 'sendNotification', { sent: true }, obj.callback);\n            }\n        } catch {\n            if (obj.callback) {\n                this.sendTo(obj.from, 'sendNotification', { sent: false }, obj.callback);\n            }\n        }\n    }\n\n    private formatNotification(notification: any): GotifyMessage {\n        const instances = notification.category.instances as Map<string, any>;\n        const readableInstances = Object.entries(instances).map(\n            ([instance, entry]) =>\n                `${instance.substring('system.adapter.'.length)}: ${this.getLatestMessage(entry.messages)}`,\n        );\n\n        const text = `${notification.category.description}\n        ${notification.host}:\n        ${readableInstances.join('\\n')}\n            `;\n\n        return {\n            message: text,\n            title: notification.category.name,\n            priority: this.getPriority(notification.severity),\n            contentType: 'text/plain',\n        };\n    }\n\n    private getPriority(severity: string): number {\n        switch (severity) {\n            case 'notify':\n                return 1;\n            case 'info':\n                return 4;\n            case 'alert':\n                return 10;\n            default:\n                return 4;\n        }\n    }\n\n    private sendMessage(message: GotifyMessage, tokenAlias?: string): void {\n        if (tokenAlias === undefined) {\n            const defaultToken = this.config.tokens.find((t: any) => t.isDefault);\n            tokenAlias = defaultToken ? defaultToken.alias : this.config.tokens[0].alias;\n        }\n\n        if (this.config.url && this.config.tokens && this.config.tokens.length > 0) {\n            // Token ausw\u00E4hlen\n            let tokenObj = this.config.tokens.find((t: any) => t.alias === tokenAlias);\n            if (!tokenObj) {\n                tokenObj = this.config.tokens[0];\n            }\n            const token = tokenObj.token;\n            axios\n                .post(`${this.config.url}/message?token=${token}`, {\n                    title: message.title,\n                    message: message.message,\n                    priority: message.priority,\n                    timeout: 1000,\n                    extras: {\n                        'client::display': {\n                            contentType: message.contentType,\n                        },\n                    },\n                })\n                .then(() => {\n                    this.log.debug('Successfully sent message to gotify');\n                })\n                .catch(error => {\n                    this.log.error(`Error while sending message to gotify:${JSON.stringify(error)}`);\n                });\n        } else {\n            this.log.error(`Cannot send notification while not configured:${JSON.stringify(message)}`);\n        }\n    }\n    private getLatestMessage(messages: any): string {\n        const latestMessage = messages.sort((a: any, b: any) => (a.ts < b.ts ? 1 : -1))[0];\n\n        return `${new Date(latestMessage.ts).toLocaleString()} ${latestMessage.message}`;\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Gotify(options);\n} else {\n    // otherwise start the instance directly\n    (() => new Gotify())();\n}\n"],
  "mappings": "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",
  "names": ["axios"]
}
